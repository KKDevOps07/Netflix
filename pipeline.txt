pipeline {
    agent any

    tools {
        jdk 'jdk17'
        nodejs 'node16'
    }

    environment {
        SCANNER_HOME = tool 'sonar-scanner'
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout from Git') {
            steps {
                git credentialsId: 'Githubaccess', url: 'https://github.com/KKDevOps07/Netflix.git'
            }
        }

        stage('Sonarqube Analysis') {
            steps {
                withSonarQubeEnv('sonar-server') {
                    sh '''
                        $SCANNER_HOME/bin/sonar-scanner \
                        -Dsonar.projectName=Netflix \
                        -Dsonar.projectKey=Netflix
                    '''
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    waitForQualityGate abortPipeline: false, credentialsId: 'Sonar-token' 
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }

        stage('OWASP FS SCAN') {
            steps {
                dependencyCheck additionalArguments: '--scan ./ --disableYarnAudit --disableNodeAudit', odcInstallation: 'DP-Check'
                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
            }
        }

        stage('TRIVY FS SCAN') {
            steps {
                sh 'trivy fs . > trivyfs.txt'
            }
        }

        stage('Docker Build & Push') {
            steps {
                withCredentials([string(credentialsId: 'tmdb_api_key', variable: 'TMDB_V3_API_KEY')]) {
                    script {
                        def imageTag = "v${env.BUILD_NUMBER}"
                        def imageName = "1819242/netflix:${imageTag}"

                        withDockerRegistry(credentialsId: 'docker', toolName: 'docker') {
                            sh """
                                docker build --build-arg TMDB_V3_API_KEY=${TMDB_V3_API_KEY} -t ${imageName} .
                                docker push ${imageName}
                            """
                        }

                        env.IMAGE_TAG = imageTag
                        env.IMAGE_NAME = imageName
                    }
                }
            }
        }

        stage('TRIVY Image SCAN') {
            steps {
                sh 'trivy image 1819242/netflix:${IMAGE_TAG} > trivyimage.txt'
            }
        }

        stage('Deploy to container') {
            steps {
                script {
                    sh 'docker rm -f netflix || true' // Stop & remove previous container if it exists
                    sh "docker run -d --name netflix -p 8081:80 1819242/netflix:${IMAGE_TAG}"
                }
            }
        }
    }

    post {
        always {
            emailext attachLog: true,
                subject: "'${currentBuild.result}'",
                body: "Project: ${env.JOB_NAME}<br/>" +
                      "Build Number: ${env.BUILD_NUMBER}<br/>" +
                      "URL: ${env.BUILD_URL}<br/>",
                to: 'kirangoud983@gmail.com',                                
                attachmentsPattern: 'trivyfs.txt,trivyimage.txt'
        }
    }
}
